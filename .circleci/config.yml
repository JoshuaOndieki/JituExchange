version: 2.1
orbs:
  node: circleci/node@5.1.0
  codecov: codecov/codecov@3.2.4
  browser-tools: circleci/browser-tools@1.4.1

# Define the jobs we want to run for this project
jobs:
  clone:
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .
  database:
    working_directory: ~/JituExchange/database
    docker:
      - image: cimg/base:2023.06
      # - image: mcr.microsoft.com/mssql-tools
    steps:
      - checkout:
          path: ~/JituExchange
      - attach_workspace:
          at: .
      - run: sudo apt-get update
      - run: sudo apt-get install -y mssql-server
      - run:
          name: setup test database
          command: bash setup.sh -t
          working_directory: ~/JituExchange/database

  build-backend:
    working_directory: ~/JituExchange/backend
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout:
          path: ~/JituExchange
      - attach_workspace:
          at: .
      - node/install-packages:
          pkg-manager: npm
      - run: npm install
      - persist_to_workspace:
          root: .
          paths:
            - backend/

  test-backend:
    working_directory: ~/JituExchange/backend
    docker:
      - image: cimg/node:18.16
    steps:
      - attach_workspace:
          at: ~/JituExchange
      # - checkout:
      #     path: ~/JituBackend
      - node/install-packages:
          pkg-manager: npm
      - run:
          command: npm test
          working_directory: ~/JituExchange/backend
      - store_artifacts:
          path: coverage/clover.xml
          destination: ./clover-backend.xml
      - codecov/upload:
          file: ./coverage/clover.xml

  build-frontend:
    working_directory: ~/JituExchange/frontend
    docker:
      - image: cimg/node:18.16
    steps:
      - attach_workspace:
          at: .
      - node/install-packages:
          pkg-manager: npm
      - persist_to_workspace:
          root: .
          paths:
            - .
  test-frontend:
    working_directory: ~/JituExchange/frontend
    docker:
      - image: cimg/node:18.16-browsers
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          command: |
            google-chrome --version
            chromedriver --version
          name: Check install
      # - checkout:
      #     path: ~/JituExchange
      - attach_workspace:
          at: ~/JituExchange
      - run:
          command: npm install
          working_directory: ~/JituExchange/frontend
      - run:
          command: npm test
          working_directory: ~/JituExchange/frontend
      - store_artifacts:
          path: coverage/clover.xml
          destination: ./clover-frontend.xml
      - codecov/upload:
          file: ./coverage/clover.xml

# Orchestrate our job run sequence
workflows:
  test:
    jobs:
      - clone
      - database:
          requires:
            - clone
      - test-backend:
          requires:
            - database
      - test-frontend:
          requires:
            - clone
  # build_and_test_backend:
    # jobs:
      # - build-backend
      # - test-backend:
      #     requires:
      #       - build-backend
  # build_and_test_frontend:
    # jobs:
      # - build-frontend
      # - test-frontend:
      #     requires:
      #       - build-frontend